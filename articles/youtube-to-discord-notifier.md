---
title: "Youtube配信や動画投稿をDiscordに通知するGASを作ったよ。"
emoji: "🤖"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["gas", "youtubeapi", "discord"]
published: true
---
## 概要
この仕組みではDiscordの特定のチャンネルにYoutubeチャンネルの動画投稿や配信情報を通知することができます。
Youtube自体にも通知機能はありますがDiscordチャンネルに通知することで複数名で話題を共有でき、コミュニティを盛り上げる助けになるのではないかと考えて作ってみました。

## 大まかな処理の流れ
以下に大まかな流れを記載します。後述するチャンネルアイコンの取得などについては触れていません。
1. トリガーによってGASが起動する
2. YoutubeチャンネルのRSSフィードからVideoIdを取得する
3. スプレッドシートにVideoIdがない場合はYouTube Data APIの[Videos: list](https://developers.google.com/youtube/v3/docs/videos/list?hl=ja)を実行し取得した情報をスプレッドシートに記録し、Discordへ通知を行います。
4. スプレッドシートにVideoIdがある場合で記録されたレコードが配信予定もしくは配信中の場合に、RSSフィードのアップデート時刻がスプレッドシートに記録された時刻と異なる場合は配信状態の変更か配信予定時刻の変更かタイトル変更かを判定し最新情報をスプレッドシートに記録し、Discordへ通知を行います。

## どんな通知がされるか？
こんな感じで動画投稿や配信予定が通知されます。それ以外にも配信中や配信完了したタイミングで通知されます。
![](/images/youtube-to-discord-notifier/image01.png)


## コードはこちら
使い方含めて詳しく書いています。
https://github.com/tatsumin39/youtube-to-discord-notifier


## こだわったポイント
### Discord通知の時のアイコン
Discordに通知する際のBotのアイコンをそのYoutubeチャンネルのアイコンとすることで識別性を高めています。
これはYouTube Data APIの[Channels: list](https://developers.google.com/youtube/v3/docs/channels/list?hl=ja)にて取得しています。

## 苦労したポイント
### API使用量の調節
YouTube Data APIは1日あたりの使用量は10,000まで利用できます。
今回は行なっていませんが検索リクエストの場合は1回あたり使用量が100と多く、Video: listやChannels: listは1回あたり使用量が1と少なかったのでまだよかったのですがコードを作成し始めたころはRSSフィードで習得したVideoIdに対して毎回APIを実行していたため1日で使用量が8,000近く上昇してしまいました。
大まかな処理の流れで記載しているように最小限のAPI実行となるように調整することでかなり落ち着いた数値で推移するようになりました。

### スプレッドシート検索時の処理速度
この仕組みではスプレッドシートに情報が蓄積されます。記事執筆時で通知対象として38チャンネルを指定し1週間ほど運用していますがその間に追加されたレコードは100件弱あります。
当初はVideoIdがスプレッドシートにあるかを検索する際に1件1件検索していました。試しにスプレッドシートにダミーデータを登録して1万件近い状態で実施したところ明らかに処理に時間がかかることがわかりました。そこでVideoIdのカラムのデータを配列に格納し、indexOfで検索することで大幅に処理速度を向上することができました。

## 今後のアップデート構想
以下のようなことを考えています。
- 配信30分前になったら通知する機能の追加
- 配信終了時の通知時にアーカイブ動画の長さ情報の追加
- Discordスラッシュコマンドによる情報取得機能の追加

現在は配信予定の通知から実際の配信開始まで時間がある場合に忘れがちになることがあります。30分前に通知を行うかスラッシュコマンドで30分以内、1時間以内のような指定をして呼び出すような仕組みがあるといいかもしれません。
もしくはDiscord上で新たなチャンネルを用意し特定条件で通知先を分けるという処理を行うという方法も考えられます。

ユーザーの利用の仕方やニーズをよく観察して決めていきたいと思います。